<!doctype html>
<html>

<head>
    <title>LUDO</title>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <link href="//fonts.googleapis.com/css?family=Monoton" rel="stylesheet" media>
    <link href="//fonts.googleapis.com/css?family=Montserrat" rel="stylesheet" media>
    <link href="//fonts.googleapis.com/css?family=Josefin+Sans" rel="stylesheet">
    <link href="//fonts.googleapis.com/css?family=Quicksand" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Cousine" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Swiper/3.4.2/css/swiper.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Swiper/3.4.2/css/swiper.min.css">
    <link href="app.css" rel="stylesheet" />
</head>

<body>
    <div id="login">
        <h1>LUDO</h1>
        <a href="/login"><img src="http://www.iconsplace.com/icons/preview/black/spotify-256.png" class="invert" width="40" height="40" /></a>
        <h2>L O G I N</h2>
    </div>
    <div id="loggedin">
        <div class="grid">
            <div class="left">
              <div class="profTemp">
                <img src="https://s-media-cache-ak0.pinimg.com/736x/24/28/10/242810087197ad884c0d895c2953a740.jpg" width="40" height="40" />
                <span>Frank Ocean</span>
              </div>
              <div class="profTemp">
                <img id="profiler" width="40" height="40" />
                <span>Toby Onono</span>
              </div>
              <div class="profTemp">
                <img src="http://saintheron.com/wp-content/uploads/2017/06/Jorja.Smith_-500x500.jpg" width="40" height="40" />
                <span>Jorja Smith</span>
              </div>
              <div class="profTemp">
                <img src="https://i1.sndcdn.com/avatars-000275328494-x0ummz-t500x500.jpg" width="40" height="40" />
                <span>Connie Constance</span>
              </div>
              <div class="profTemp">
                <img src="http://saintheron.com/wp-content/uploads/2017/06/c_scale-f_auto-w_706-v1496982318-this-song-is-sick-media-image-vince-staples-rain-come-down-1496982318024-png-500x500.png" width="40" height="40" />
                <span>Vince Staples</span>
              </div>
              <div class="profTemp">
                <img src="http://saintheron.com/wp-content/uploads/2017/03/goldlink-release-date-cover-art-at-what-cost-2017-album-500x500.jpg" width="40" height="40" />
                <span>Goldlink</span>
              </div>
              <div class="profTemp">
                <img src="https://www.tinymixtapes.com/sites/default/files/imagecache/Article_Width/1412/artworks-000097529084-s9nava-t500x500.jpg" width="40" height="40" />
                <span>NAO</span>
              </div>
              <div class="profTemp">
                <img src="https://i1.sndcdn.com/avatars-000282552589-ewmqcs-t500x500.jpg" width="40" height="40" />
                <span>Brent Faiyaz</span>
              </div>
              <div class="profTemp">
                <img src="http://superselected.com/wp-content/uploads/2014/08/Kelela-2.jpg" width="40" height="40" />
                <span>Kelela</span>
              </div>
              <div class="profTemp">
                <img src="http://cdn-s3.allmusic.com/release-covers/500/0004/624/0004624822.jpg" width="40" height="40" />
                <span>Solange</span>
              </div>
              <div class="profTemp">
                <img src="http://saintheron.com/wp-content/uploads/2016/05/sampha1-500x500.jpg" width="40" height="40" />
                <span>Sampha</span>
              </div>
              <div class="profTemp">
                <img src="http://www.straight.com/files/v3/images/17/01/sango.jpg" width="40" height="40" />
                <span>Sango</span>
              </div>
              <div class="profTemp">
                <img src="https://brightsidelive.com/wp-content/uploads/earl-sweatshirt.jpg" width="40" height="40" />
                <span>Earl Sweatshirt</span>
              </div>
              <div class="profTemp">
                <img src="https://68.media.tumblr.com/5e687ecaa7e8bae1e20e9c80e51185ad/tumblr_o5tp3ucSMB1rtauc1o1_500.jpg" width="40" height="40" />
                <span>Skepta</span>
              </div>
              <div class="profTemp">
                <img src="https://s3.amazonaws.com/bucketeer-373b822b-859a-491c-934d-506d803eb341/artist/vfd9Q9nlJ8adbEtVW9o1nezrbx5Km3Nip3w978xR" width="40" height="40" />
                <span>Ray Blk</span>
              </div>
              <div class="profTemp">
                <img src="https://www.tinymixtapes.com/sites/default/files/imagecache/Article_Width/1412/artworks-000097529084-s9nava-t500x500.jpg" width="40" height="40" />
                <span>NAO</span>
              </div> 
              <div class="profTemp">
                <img src="https://i1.sndcdn.com/artworks-000128440509-uqhyuv-t500x500.jpg" width="40" height="40" />
                <span>Rex Orange County</span>
              </div>
              <div class="profTemp">
                <img src="https://s-media-cache-ak0.pinimg.com/originals/09/b7/27/09b727b145efb31556e50fb5ecbd0774.jpg" width="40" height="40" />
                <span>King Krule</span>
              </div>
              <div class="profTemp">
                <img src="https://i1.sndcdn.com/avatars-000210207184-xy9abz-t500x500.jpg" width="40" height="40" />
                <span>Jamie Isaac</span>
              </div>             
              <div class="profTemp">
                <img src="http://68.media.tumblr.com/3e2529b6651bc7c91683192af22339a8/tumblr_oo0tyzV1Fl1tc0atto1_500.jpg" width="40" height="40" />
                <span>Adwoah Aboah</span>
              </div>
              <div class="profTemp">
                <img src="http://hbr.co.ke/wp-content/uploads/2017/06/SZA-blue-box.jpg" width="40" height="40" />
                <span>SZA</span>
              </div>
            </div>
            <div class="center">
                <h1>LUDO</h1>
                  <div class="swiper-container">
                    <div class="swiper-wrapper">
                      <div class="swiper-slide">
                        <div class="getCurrentTrack">
                          <div class="trackTemplate">
                              <img id="trackimg" width="350" height="350" />
                              <figcaption id="songName"></figcaption>
                              <figcaption id="artistName"></figcaption>
                              <figcaption id="albumName"></figcaption>
                              <img class="invert" id ="add" src="http://indianassist.mx/img/downArrow.png" height="20" width="20" />
                          </div>
                        </div>
                      </div>
                      <div class="swiper-slide">
                        <div class="getCurrentTrack">
                          <div class="trackTemplate">
                              <img src="https://s-media-cache-ak0.pinimg.com/736x/24/28/10/242810087197ad884c0d895c2953a740.jpg" width="350" height="350" />
                              <figcaption id="songName">songName</figcaption>
                              <figcaption id="artistName">songName</figcaption>
                              <figcaption id="albumName">songName</figcaption>
                              <img class="invert" id ="add" src="http://indianassist.mx/img/downArrow.png" height="20" width="20" />
                          </div>
                        </div>
                      </div>
                      <div class="swiper-slide">
                        <div class="getCurrentTrack">
                          <div class="trackTemplate">
                              <img src="https://s-media-cache-ak0.pinimg.com/736x/24/28/10/242810087197ad884c0d895c2953a740.jpg" width="350" height="350" />
                              <figcaption id="songName">songName</figcaption>
                              <figcaption id="artistName">songName</figcaption>
                              <figcaption id="albumName">songName</figcaption>
                              <img class="invert" id ="add" src="http://indianassist.mx/img/downArrow.png" height="20" width="20" />
                          </div>
                        </div>
                      </div> 
                    </div>
                    <div class="swiper-button-prev swiper-button-white"></div>
                    <div class="swiper-button-next swiper-button-white"></div> 
                  </div>    
            </div>
            <div class="right">
              <div class="player">
                    <input type="image" id="previous" src="http://freeiconbox.com/icon/256/20648.png" width="25" height="25" />
                    <input type="image" name="play-pause" src="https://cdn3.iconfinder.com/data/icons/google-material-design-icons/48/ic_play_arrow_48px-512.png"  width="25" height="25" />
                    <input type="image" id="fast-forward" src="http://freeiconbox.com/icon/256/20648.png" class="flip" width="25" height="25" />
                </div>
               <input type="checkbox" id="toggle" />
               <label for="toggle">Toggle</label>
            </div>
        </div>
    </div>
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Swiper/3.4.2/js/swiper.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Swiper/3.4.2/js/swiper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Swiper/3.4.2/js/swiper.jquery.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Swiper/3.4.2/js/swiper.jquery.min.js"></script>
    <script>
      var swiper = new Swiper('.swiper-container', {
        pagination: '.swiper-pagination',
        slidesPerView: 4,
        centeredSlides: true,
        paginationClickable: true,
        spaceBetween: 100,
        nextButton: '.swiper-button-next',
        prevButton: '.swiper-button-prev',
      });
    </script>
    <script>
    (function() {
        /**
         * Obtains parameters from the hash of the URL
         * @return Object
         */
        function getHashParams() {
            var hashParams = {};
            var e, r = /([^&;=]+)=?([^&;]*)/g,
                q = window.location.hash.substring(1);
            while (e = r.exec(q)) {
                hashParams[e[1]] = decodeURIComponent(e[2]);
            }
            return hashParams;
        }


        var params = getHashParams();

        var access_token = params.access_token,
            refresh_token = params.refresh_token,
            error = params.error;

        function refreshToken() {
            $.ajax({
                url: '/refresh_token',
                data: {
                    'refresh_token': refresh_token
                }
            }).done(function(data) {
                access_token = data.access_token;
            });
        }

        if (error) {
            alert('There was an error during the authentication');
        } else {
            if (access_token) {

                /*$.ajax({
                    url: 'https://api.spotify.com/v1/me',
                    headers: {
                      'Authorization': 'Bearer ' + access_token
                    },
                    success: function(response) {
                      userProfilePlaceholder.innerHTML = userProfileTemplate(response);

                      $('#login').hide();
                      $('#loggedin').show();
                    }
                });
                */
                var imgsrc;
                var currentUserName;
                var profiler;
                var songName;
                var artistName;
                var albumName;
                var progress;
                var songLength;
                var songURL;
                var isPlaying;
                var playbackArray = [];
                var i = 0;


                var jsonPushData = {
                    userName: currentUserName,
                    albumArt: imgsrc,
                    songName: songName,
                    artistName: artistName,
                    albumName: albumName,
                    songProgress: progress,
                    songLength: songLength,
                    songURL: songURL,
                    isPlaying: isPlaying
                };



                function showPlayBackHistory(playbackArray) {
                    var image = document.createElement('img');
                    var song = document.createElement('figcaption');
                    var artist = document.createElement('figcaption');
                    var album1 = document.createElement('figcaption');

                    image.src = playbackArray[1].imgURL;
                    song.textContent = playbackArray[1].nameOfSong;
                    artist.textContent = playbackArray[1].artistName;
                    album1 = playbackArray[1].nameOfAlbum;

                    var template = document.getElementById('trackTemplate');
                    template.appendChild(image, song, artist, album1);
                    console.log(template + "TEMPLATE");

                }

                displayUserInfo();
                getCurrentSong();


                function getCurrentSong() {


                    $.ajax({
                        url: 'https://api.spotify.com/v1/me/player/currently-playing',
                        headers: {
                            'Authorization': 'Bearer ' + access_token
                        },
                        success: function(response) {

                            imgsrc = response.item.album.images[0].url;
                            songName = response.item.name;
                            artistName = response.item.artists[0].name;
                            albumName = response.item.album.name;
                            progress = response.progress_ms;
                            songLength = response.timestamp;
                            songURL = response.item.external_urls;
                            isPlaying = response.is_playing;


                            var user = returnUser();

                            jsonPushData = {
                                userName: user,
                                albumArt: imgsrc,
                                songName: songName,
                                artistName: artistName,
                                albumName: albumName,
                                songProgress: progress,
                                songLength: songLength,
                                songURL: songURL,
                                isPlaying: isPlaying
                            };


                            if (playbackArray.length == 0) {
                                playbackArray[i] = jsonPushData;

                                if (user) {
                                    $.ajax({
                                        data: JSON.stringify(jsonPushData),
                                        url: '/updateJSON',
                                        method: "POST",
                                        contentType: "application/json",
                                        dataType: 'json',
                                        success: function(response) {
                                            //console.log(currentUserName);
                                        }
                                    });
                                }

                                i = i + 1;

                                console.log(playbackArray);

                                getJSON();
                            } else if ((playbackArray[0].songName != songName)) {

                                var startIndex = 0;
                                var numElemtoRemove = 0;
                                playbackArray.splice(startIndex, numElemtoRemove, jsonPushData);
                                i = i + 1;

                                var swiperSlide = document.createElement('div');
                                swiperSlide.className = 'swiper-slide';
                                
                                var getCurrentTrack = document.createElement('div');
                                getCurrentTrack.className = 'getCurrentTrack';
                                
                                var trackTemplate = document.createElement('div');
                                trackTemplate.className = 'trackTemplate';

                                var image = document.createElement('img');
                                image.src = jsonPushData.songURL;
                                image.height = 400;
                                image.width =400;

                                var song = document.createElement('figcaption');
                                song.text = jsonPushData.songName;

                                var artist = document.createElement('figcaption');
                                artist.text = jsonPushData.artistName;

                                var album = document.createElement('figcaption');
                                album.text = jsonPushData.albumName;

                                var add = document.createElement('img');
                                add.src = document.getElementById('add').src;

                                trackTemplate.appendChild(image);
                                trackTemplate.appendChild(song);
                                trackTemplate.appendChild(artist);
                                trackTemplate.appendChild(album);
                                trackTemplate.appendChild(add);

                                getCurrentTrack.appendChild(trackTemplate);
                                swiperSlide.appendChild(getCurrentTrack);

                                $('swiper-wrapper').prepend(swiperSlide);


                                if (user) {
                                    $.ajax({
                                        data: JSON.stringify(jsonPushData),
                                        url: '/updateJSON',
                                        method: "POST",
                                        contentType: "application/json",
                                        dataType: 'json',
                                        success: function(response) {
                                        }
                                    });
                                }

                                getJSON();
                                displayLive();
                                console.log(playbackArray);
                                //console.log(playbackArray);

                            }

                            document.getElementById("trackimg").src = imgsrc;
                            document.getElementById("songName").innerHTML = songName;
                            document.getElementById("artistName").innerHTML = artistName;
                            document.getElementById("albumName").innerHTML = albumName;
                            //console.log(response);



                            $('#login').hide();
                            $('#loggedin').show();
                        }
                    });
                    setTimeout(getCurrentSong, 20000);
                }

                function displayUserInfo() {
                    refreshToken();
                    $.ajax({
                        url: 'https://api.spotify.com/v1/me',
                        headers: {
                            'Authorization': 'Bearer ' + access_token
                        },
                        success: function(response) {
                            profiler = response.images[0].url;
                            currentUserName = response.display_name;
                            if (!currentUserName) {
                                currentUserName = response.id;
                            }
                            document.getElementById("profiler").src = profiler;
                        }
                    });
                }

                function getJSON() {
                    $.ajax({
                        url: '/getJSON',
                        dataType: 'json',
                        success: function(response) {
                            console.log(response);
                        }
                    });
                }


                function returnUser() {
                    return currentUserName;
                }

                function returnProfiler() {
                    return profiler;
                }
                document.getElementById('toggle').addEventListener('click', function() {
                    var user = returnUser();
                    var profiler = returnProfiler();
    
                    var live = this.checked;
                    var userNameData = {
                        userNameData: user,
                        active: live,
                        profiler: profiler
                    };

                    $.ajax({
                        data: JSON.stringify(userNameData),
                        url: '/updateUserStatus',
                        method: 'POST',
                        contentType: 'application/json',
                        dataType: 'json',
                        success: function(response) {
              
                        }
                    });
                });

                function displayLive(){
                  $.ajax({
                        url: '/showLive',
                        dataType: 'json',
                        contentType: 'application/json',
                        success: function(response) {
                            var test = JSON.parse(response);
                            console.log(test.active[0]);

                            $('.left').prepend($('<div/>', {class: 'profTemp'}).append(
                              $('<img/>', {src: test.active[0].profiler, width: 40, height: 40}),
                              $('<span/>', {text: " " + test.active[0].userNameData})));

                        }
                    });
                }

                

                document.getElementById('previous').addEventListener('click', function() {
                    refreshToken();
                    $.ajax({
                        url: 'https://api.spotify.com/v1/me/player/previous',
                        type: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + access_token
                        },
                        success: function() {
                            console.log("it skipped");
                        }
                    });
                });

                document.getElementById('fast-forward').addEventListener('click', function() {
                    $.ajax({
                        url: '/test',
                        type: 'GET',
                        success: function() {
                            console.log("IT SHOULD HAVE DONE SOMETHING");
                        }
                    });
                });

                //}

            } else {
                // render initial screen
                $('#login').show();
                $('#loggedin').hide();
            }
        }
    })();
    </script>
     
</body>

</html>
