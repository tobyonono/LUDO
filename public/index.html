<!doctype html>
<html>
<head>
  <title>Example of the Authorization Code flow with Spotify</title>
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
  <link href="https://fonts.googleapis.com/css?family=Monoton" rel="stylesheet" media>
  <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet" media>
  <link href="https://fonts.googleapis.com/css?family=Josefin+Sans" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Quicksand" rel="stylesheet">
  <link href="app.css" rel="stylesheet" />
</head>

<body>
  <div class="container">
    <div id="login">
      <h1>LUDO</h1>
      <a href="/login"><img src="https://assets.ifttt.com/images/channels/51464135/icons/on_color_large.png" width="40" height="40" /></a>
      <h2>L O G I N</h2>
    </div>
    <div id="loggedin">
     <img id="profiler" width="40" height="40" />
      <h1>LUDO</h1>   
      <div id ="getCurrentTrack">
       <img id="trackimg" width="250" height="250" />
        <p><span id="songName"></span></p>
        <p><span id="artistName"></span></p>
        <p><span id="albumName"></span></p>
      </div>
      <div>
       <input type="image" id="previous" src="http://freeiconbox.com/icon/256/20648.png" class="invert" width="25" height="25" />
       <input type="image" name="play-pause" src="http://iconizer.net/files/DefaultIcon_ver_0.11/orig/media-play.png" class="invert" width="25" height="25" />
       <input type="image" name="fast-forward" src="http://freeiconbox.com/icon/256/20648.png" class="flip" width="25" height="25" /> 
      </div>
    </div>
  </div>
</div>

<script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
<script>
  (function() {

        /**
         * Obtains parameters from the hash of the URL
         * @return Object
         */
         function getHashParams() {
          var hashParams = {};
          var e, r = /([^&;=]+)=?([^&;]*)/g,
          q = window.location.hash.substring(1);
          while ( e = r.exec(q)) {
           hashParams[e[1]] = decodeURIComponent(e[2]);
         }
         return hashParams;
       }


       var params = getHashParams();

       var access_token = params.access_token,
       refresh_token = params.refresh_token,
       error = params.error;

       function refreshToken()
       {
        $.ajax({
              url: '/refresh_token',
              data: {
                'refresh_token': refresh_token
              }
            }).done(function(data) {
              access_token = data.access_token;
            });
       }

       if (error) 
       {
        alert('There was an error during the authentication');
      } 
      else 
      {
        if (access_token) 
        {

            /*$.ajax({
                url: 'https://api.spotify.com/v1/me',
                headers: {
                  'Authorization': 'Bearer ' + access_token
                },
                success: function(response) {
                  userProfilePlaceholder.innerHTML = userProfileTemplate(response);

                  $('#login').hide();
                  $('#loggedin').show();
                }
            });
            */
            displayUserInfo();
            getCurrentSong();
            function getCurrentSong()
            {
             console.log(getCurrentSong);
             $.ajax({
              url: 'https://api.spotify.com/v1/me/player/currently-playing',
              headers: {
                'Authorization': 'Bearer ' + access_token
              },
              success: function(response) {
                  //currentTrackPlaceholder.innerHTML = currentTrackTemplate(response);
                  
                  console.log(response);
                  var imgsrc = response.item.album.images[0].url;
                  var songName = response.item.name;
                  var artistName = response.item.artists[0].name;
                  var albumName = response.item.album.name;
                  
                  document.getElementById("trackimg").src = imgsrc;
                  document.getElementById("songName").innerHTML = songName;
                  document.getElementById("artistName").innerHTML = artistName;
                  document.getElementById("albumName").innerHTML = albumName;
                  console.log(response);

                  $('#login').hide();
                  $('#loggedin').show();
                }
              });
             setTimeout(getCurrentSong, 5000);
           }

           function displayUserInfo()
           {
            refreshToken();
            $.ajax({
              url: 'https://api.spotify.com/v1/me',
              headers: {
                'Authorization': 'Bearer ' + access_token
              },
              success: function(response){
                var imgsrc = response.images[0].url;
                document.getElementById("profiler").src = imgsrc;
                console.log(response);
              }
            });
           }

           //function playerManip()
           //{
            document.getElementById('previous').addEventListener('click', function() 
            {
              refreshToken();
              $.ajax({
                url:'https://api.spotify.com/v1/me/player/previous',
                type: 'POST',
                headers: {
                  'Authorization': 'Bearer ' + access_token
                },
                success: function(){
                  console.log("it skipped");
                }
              })
            });
           //}
           
         } 
         else 
         {
              // render initial screen
              $('#login').show();
              $('#loggedin').hide();
            }       
          }
        })();
      </script>
    </body>
    </html>

