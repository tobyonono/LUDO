<!doctype html>
<html>
<head>
  <title>LUDO</title>
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
  <link href="https://fonts.googleapis.com/css?family=Monoton" rel="stylesheet" media>
  <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet" media>
  <link href="https://fonts.googleapis.com/css?family=Josefin+Sans" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Quicksand" rel="stylesheet">
  <link href="app.css" rel="stylesheet" />
</head>

<body>
  <div class="container">
    <div id="login">
      <h1>LUDO</h1>
      <a href="/login"><img src="https://assets.ifttt.com/images/channels/51464135/icons/on_color_large.png" width="40" height="40" /></a>
      <h2>L O G I N</h2>
    </div>
    <div id="loggedin">
      <div class="header-icons">
       <h1>LUDO</h1>
       <img id="profiler" width="40" height="40" />
      </div>   
      <div id ="getCurrentTrack">
       <div id="trackTemplate">
        <img id="trackimg" width="250" height="250" />
        <figcaption id="songName"></figcaption> 
        <figcaption id="artistName"></figcaption> 
        <figcaption id="albumName"></figcaption> 
       </div>
      </div>
      <div class="player">
       <input type="image" id="previous" src="http://freeiconbox.com/icon/256/20648.png" class="invert" width="25" height="25" />
       <input type="image" name="play-pause" src="http://iconizer.net/files/DefaultIcon_ver_0.11/orig/media-play.png" class="invert" width="25" height="25" />
       <input type="image" id="fast-forward" src="http://freeiconbox.com/icon/256/20648.png" class="flip" width="25" height="25" /> 
      </div>
    </div>
  </div>
</div>

<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>

<script>
  (function() {

        /**
         * Obtains parameters from the hash of the URL
         * @return Object
         */
         function getHashParams() {
          var hashParams = {};
          var e, r = /([^&;=]+)=?([^&;]*)/g,
          q = window.location.hash.substring(1);
          while ( e = r.exec(q)) {
           hashParams[e[1]] = decodeURIComponent(e[2]);
         }
         return hashParams;
       }


       var params = getHashParams();

       var access_token = params.access_token,
       refresh_token = params.refresh_token,
       error = params.error;

       function refreshToken()
       {
        $.ajax({
              url: '/refresh_token',
              data: {
                'refresh_token': refresh_token
              }
            }).done(function(data) {
              access_token = data.access_token;
            });
       }

       if (error) 
       {
        alert('There was an error during the authentication');
      } 
      else 
      {
        if (access_token) 
        {

            /*$.ajax({
                url: 'https://api.spotify.com/v1/me',
                headers: {
                  'Authorization': 'Bearer ' + access_token
                },
                success: function(response) {
                  userProfilePlaceholder.innerHTML = userProfileTemplate(response);

                  $('#login').hide();
                  $('#loggedin').show();
                }
            });
            */
            var imgsrc;
            var currentUserName;
            var songName;
            var artistName;
            var albumName;
            var playbackArray = new Array();
            
            var metadata = {albumArt:imgsrc, songName:songName, artistName:artistName, albumName:albumName};
            playbackArray[0] = metadata;


            function showPlayBackHistory (playbackArray)
            { 
              var image = document.createElement('img');
              var song = document.createElement('figcaption');
              var artist = document.createElement('figcaption');
              var album1 = document.createElement('figcaption');

              image.src = playbackArray[1].imgURL;
              song.textContent = playbackArray[1].nameOfSong;
              artist.textContent = playbackArray[1].artistName;
              album1 = playbackArray[1].nameOfAlbum;

              var template = document.getElementById('trackTemplate');
              template.appendChild(image, song, artist, album1);
              console.log(template + "TEMPLATE");
               
            }
            

            displayUserInfo();
            getCurrentSong();

            function getCurrentSong()
            {
             

             $.ajax({
              url: 'https://api.spotify.com/v1/me/player/currently-playing',
              headers: {
                'Authorization': 'Bearer ' + access_token
              },
              success: function(response) {
                  
                  imgsrc = response.item.album.images[0].url;
                  songName = response.item.name;
                  artistName = response.item.artists[0].name;
                  albumName = response.item.album.name;

                  var jsonPushData = {clients: {
                      userName:currentUserName, 
                      albumArt:imgsrc, 
                      songName:songName, 
                      artistName:artistName, 
                      albumName:albumName
                    
                  }};

                  JSON.stringify(jsonPushData);

                   $.ajax({
                    data: {jsonPushData},
                    url:'/updateArray',
                    method: "POST",
                  }).done(function(){
                    console.log("It saved Properly...hopefully ");
                  });

                  //console.log(jsonPushData);

                  if(playbackArray == null || (playbackArray[0].albumArt != imgsrc && playbackArray[0].songName != songName))
                  {
                    metadata = {albumArt:imgsrc, songName:songName, artistName:artistName, albumName:albumName};
                    var startIndex = 0;
                    var numElemtoRemove = 0;

                    playbackArray.splice(startIndex, numElemtoRemove, metadata);
                    //console.log(playbackArray);
                  }
                  
                  document.getElementById("trackimg").src = imgsrc;
                  document.getElementById("songName").innerHTML = songName;
                  document.getElementById("artistName").innerHTML = artistName;
                  document.getElementById("albumName").innerHTML = albumName;
                  //console.log(response);

                  $('#login').hide();
                  $('#loggedin').show();
                }
              });
             setTimeout(getCurrentSong, 20000);
           }

           function displayUserInfo()
           {
            refreshToken();
            $.ajax({
              url: 'https://api.spotify.com/v1/me',
              headers: {
                'Authorization': 'Bearer ' + access_token
              },
              success: function(response){
                var imgsrc = response.images[0].url;
                currentUserName = response.display_name;
                document.getElementById("profiler").src = imgsrc;
                console.log(currentUserName);
              }
            });
           }

           //function playerManip()
           //{
            document.getElementById('previous').addEventListener('click', function() 
            {
              refreshToken();
              $.ajax({
                url:'https://api.spotify.com/v1/me/player/previous',
                type: 'POST',
                headers: {
                  'Authorization': 'Bearer ' + access_token
                },
                success: function(){
                  console.log("it skipped");
                }
              })
            });

            document.getElementById('fast-forward').addEventListener('click', function() 
            {
              $.ajax({
                url: '/test',
                type: 'GET',
                success: function(){
                  console.log("IT SHOULD HAVE DONE SOMETHING");
                }
              })
            });

           //}
           
         } 
         else 
         {
              // render initial screen
              $('#login').show();
              $('#loggedin').hide();
            }       
          }
        })();
      </script>
    </body>
    </html>

